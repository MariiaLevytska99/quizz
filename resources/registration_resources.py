import binascii
import smtplib
import ssl

from resources.email_resources import send_email
from flask_restful import Resource
from flask import request
import os
import hashlib
from db import db
from sqlalchemy import or_
from models.user import User


class RegistrationResource(Resource):
    def post(self):
        payload = request.get_json(force=True)
        password = payload.get('password')

        salt = hashlib.sha256(os.urandom(60)).hexdigest().encode('ascii')
        password_hash = hashlib.pbkdf2_hmac('sha512', password.encode('utf-8'), salt, 100000)
        pwdhash = binascii.hexlify(password_hash)
        key = (salt + pwdhash).decode('ascii')

        if (User.query.filter(or_(User.email == payload.get('email'), User.username == payload.get('username')))
                .first()):
            return 400

        new_user = User(username=payload.get('username'), email=payload.get('email'), password=key)

        db.session.add(new_user)
        db.session.commit()
        send_email(new_user.email)

        def send(self, receiver_email):
            port = 587  # For starttls
            smtp_server = "smtp.gmail.com"
            sender_email = "quizzery.quiz@gmail.com"
            password = "newpassword12345"
            message =  "??????!?? ??????????? ????, ?? ?? ???????? ??????????  ?? Quizzery ?? ?????????? ?????????? ???? ??????? \
            ? ?????? ????'??????? ???????!\
            ????????, ?? ?? ????????? ? ???? ???? ???????? ??????, ??????????? ?????? ???????? ?????????? ?? ???????? ????? ??????!  "

            theme = "??????? ??? ? Quizzery!"
            context = ssl.create_default_context()
            message2 = 'Subject: {}\n\n{}'.format(theme, message)
            with smtplib.SMTP(smtp_server, port) as server:
                server.ehlo()  # Can be omitted
                server.starttls(context=context)
                server.ehlo()  # Can be omitted
                server.login(sender_email, password)
                server.sendmail(sender_email, receiver_email, message2)
                return "Sent"

